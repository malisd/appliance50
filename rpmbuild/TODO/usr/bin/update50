#!/bin/env php
<?php

    // check for updates
    $updates = array();
    print("Checking for updates...\n");
    exec("sudo yum clean metadata");
    exec("sudo yum --disablerepo=* --enablerepo=appliance50 list updates 2>&1", $output, $return_var);
    if ($return_var !== 0) {
        print("Appliance does not seem to have Internet access. Restarting networking...\n");
        exec("sudo service network restart");
        print("Restarted networking.\n");
        print("Rechecking for updates...\n");
        exec("sudo yum --disablerepo=* --enablerepo=appliance50 list available 2>&1", $output, $return_var);
        if ($return_var !== 0) {
            print("Appliance still does not seem to have Internet access.\n");
            print("Try restarting the appliance and also your computer!\n");
            exit(1);
        }
    }
    foreach ($output as $line) {
        if (preg_match("/^([^\s]+)\s+([^\s]+)\s+appliance50$/", $line, $matches)) {
            array_push($updates, $matches[1]);
        }
    }

    // count updates
    if (($n = count($updates)) !== 0) {
        print("Found $n " . (($n == 1) ? "update" : "updates") . ".\n");
    }
    else {
        print("Appliance is up-to-date.\n");
        exit(0);
    }

    // update
    print("Updating appliance...  This may take a few minutes.\n");
    print("\nDO NOT CLOSE THIS WINDOW OR PUT YOUR COMPUTER TO SLEEP <3\n\n");
    passthru(escapeshellcmd("sudo yum -y update " . join(" ", $updates)));

?>
